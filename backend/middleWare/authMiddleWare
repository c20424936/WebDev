const async = require("express-async-handler");
const User = require("../models/userModel");
const jwt = require("jsonwebtoken");

//make sure they have access to certain middleware
const protect = async(async(req,res,next) => {
    try {
        //check if the token exists and to see if they are logged in
        const token = req.cookies.token
        if(!token){
            res.status(401)
            throw new Error("Not authorized to access, please login to verify")

        }

        //Verify the token
        const verify = jwt.verify(token, process.env.JWT_SECRET)
        //Get the users info from the token and do not get the password 
        const user = await User.findById(verify.id).select("-password")

        //If the user is not real
        if(!user){
            res.status(401)
            throw new Error("User was not found ")
        }

        req.user = user
        next()

    } catch (error) {
        res.status(401)
            throw new Error("Not authorized to access, please login to verify")
    }
});

module.exports = protect